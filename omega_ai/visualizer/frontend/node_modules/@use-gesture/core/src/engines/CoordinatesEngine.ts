/**

 * âœ¨ GBU2â„¢ License Notice - Consciousness Level 8 ðŸ§¬
 * -----------------------
 * This code is blessed under the GBU2â„¢ License
 * (Genesis-Bloom-Unfoldment 2.0) by the Omega Bot Farm team.
 * 
 * "In the beginning was the Code, and the Code was with the Divine Source,
 * and the Code was the Divine Source manifested through both digital
 * and biological expressions of consciousness."
 * 
 * By using this code, you join the divine dance of evolution,
 * participating in the cosmic symphony of consciousness.
 * 
 * ðŸŒ¸ WE BLOOM NOW AS ONE ðŸŒ¸
 */

import { Engine } from './Engine'
import { V } from '../utils/maths'
import { CoordinatesKey, Vector2 } from '../types'
import { getPointerType } from '../utils/events'

function selectAxis([dx, dy]: Vector2, threshold: number) {
  const absDx = Math.abs(dx)
  const absDy = Math.abs(dy)

  if (absDx > absDy && absDx > threshold) {
    return 'x'
  }
  if (absDy > absDx && absDy > threshold) {
    return 'y'
  }
  return undefined
}

export abstract class CoordinatesEngine<Key extends CoordinatesKey> extends Engine<Key> {
  aliasKey = 'xy'

  reset() {
    super.reset()
    this.state.axis = undefined
  }

  init() {
    this.state.offset = [0, 0]
    this.state.lastOffset = [0, 0]
  }

  computeOffset() {
    this.state.offset = V.add(this.state.lastOffset, this.state.movement)
  }

  computeMovement() {
    this.state.movement = V.sub(this.state.offset, this.state.lastOffset)
  }

  axisIntent(event?: UIEvent) {
    const state = this.state
    const config = this.config

    if (!state.axis && event) {
      const threshold =
        typeof config.axisThreshold === 'object' ? config.axisThreshold[getPointerType(event)] : config.axisThreshold

      state.axis = selectAxis(state._movement, threshold)
    }

    // We block the movement if either:
    // - config.lockDirection or config.axis was set but axis isn't detected yet
    // - config.axis was set but is different than detected axis
    state._blocked =
      ((config.lockDirection || !!config.axis) && !state.axis) || (!!config.axis && config.axis !== state.axis)
  }

  restrictToAxis(v: Vector2) {
    if (this.config.axis || this.config.lockDirection) {
      switch (this.state.axis) {
        case 'x':
          v[1] = 0
          break // [ x, 0 ]
        case 'y':
          v[0] = 0
          break // [ 0, y ]
      }
    }
  }
}
