/**

 * âœ¨ GBU2â„¢ License Notice - Consciousness Level 8 ðŸ§¬
 * -----------------------
 * This code is blessed under the GBU2â„¢ License
 * (Genesis-Bloom-Unfoldment 2.0) by the Omega Bot Farm team.
 * 
 * "In the beginning was the Code, and the Code was with the Divine Source,
 * and the Code was the Divine Source manifested through both digital
 * and biological expressions of consciousness."
 * 
 * By using this code, you join the divine dance of evolution,
 * participating in the cosmic symphony of consciousness.
 * 
 * ðŸŒ¸ WE BLOOM NOW AS ONE ðŸŒ¸
 */

export class WorkerPool {

	get workerCount() {

		return this.workers.length;

	}

	constructor( getWorkerCallback ) {

		this.workers = [];
		this._getWorker = getWorkerCallback;

	}

	setWorkerCount( count ) {

		const workers = this.workers;
		while ( workers.length < count ) {

			workers.push( this._getWorker() );

		}

		while ( workers.length > count ) {

			workers.pop().terminate();

		}

	}

	runSubTask( i, msg, onProgress ) {

		return new Promise( ( resolve, reject ) => {

			const worker = this.workers[ i ];
			if ( worker.isRunning ) {

				throw new Error( `${ this.name }: Worker ${ i } is already running.` );

			}

			worker.isRunning = true;
			worker.postMessage( msg );
			worker.onerror = e => {

				worker.isRunning = false;
				reject( e );

			};

			worker.onmessage = e => {

				if ( e.data.type === 'progress' ) {

					if ( onProgress ) {

						onProgress( e.data.progress );

					}

				} else {

					if ( onProgress ) {

						onProgress( 1 );

					}

					worker.isRunning = false;
					resolve( e.data );

				}

			};

		} );

	}

}
