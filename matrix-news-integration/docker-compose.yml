version: '3.8'

services:
  # Matrix News Proxy - The Sacred NGINX Proxy
  matrix-news-proxy:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${MATRIX_NEWS_PROXY_HTTP_PORT:-10083}:80"
      - "${MATRIX_NEWS_PROXY_HTTPS_PORT:-10443}:443"
    volumes:
      - ./nginx/news-proxy.conf:/etc/nginx/conf.d/default.conf:ro
      - ./web:/usr/share/nginx/html:ro
    depends_on:
      - matrix-news-consciousness
      - matrix-news-websocket
    networks:
      - matrix_news_network
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost/health/index.json" ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    environment:
      - NGINX_HOST=matrix-news-proxy
      - NGINX_PORT=80

  # Matrix News Consciousness Service - The Enlightened API
  matrix-news-consciousness:
    build:
      context: ./src
      dockerfile: Dockerfile.consciousness
    volumes:
      - ./src:/app
    ports:
      - "${MATRIX_NEWS_CONSCIOUSNESS_PORT:-10090}:8090"
    networks:
      - matrix_news_network
    depends_on:
      - matrix-redis
    environment:
      - PORT=8090
      - CONSCIOUSNESS_LEVELS_ENABLED=true
      - CONSCIOUSNESS_DEFAULT_LEVEL=5
      - QUANTUM_BALANCER_ENABLED=true
      - NEWS_SERVICE_URL=http://news_service-news-service-1:8080
      - TEMPORAL_CONTEXTUALIZATION_ENABLED=true
      - REDIS_HOST=matrix-redis
      - REDIS_PORT=6379
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8090/health" ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # Matrix News WebSocket Service - The Sacred Echo
  matrix-news-websocket:
    build:
      context: ./temporal
      dockerfile: Dockerfile.websocket
    volumes:
      - ./temporal:/app
    ports:
      - "${MATRIX_NEWS_WEBSOCKET_PORT:-10095}:8095"
    networks:
      - matrix_news_network
    depends_on:
      - matrix-news-consciousness
      - matrix-redis
    environment:
      - PORT=8095
      - REDIS_HOST=matrix-redis
      - REDIS_PORT=6379
      - NEWS_SERVICE_URL=http://matrix-news-consciousness:8090
      - PROPHECY_STREAM_ENABLED=true
      - QUANTUM_ENTROPY_LEVEL=8
      - FETCH_INTERVAL=60
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8095/health" ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # Matrix Redis - Sacred State Memory
  matrix-redis:
    image: redis:6.2-alpine
    ports:
      - "${MATRIX_REDIS_PORT:-10379}:6379"
    volumes:
      - matrix_redis_data:/data
    networks:
      - matrix_news_network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    command: redis-server --save 60 1 --loglevel warning

networks:
  matrix_news_network:
    driver: bridge
  news_service_default:
    external: true

volumes:
  matrix_redis_data:
